name: Manual Kernel Build (ARM 32-bit)

on:
  workflow_dispatch:
    inputs:
      defconfig_name:
        description: 'Name of the defconfig file (inside arch/arm/configs/)'
        required: true
        default: 'x653c_defconfig' 

jobs:
  build-kernel:
    runs-on: ubuntu-22.04

    steps:
    # 1. Clone the repository
    - name: Checkout Source Code
      uses: actions/checkout@v4
      with:
        repository: monkey-d/inifnix-smart-4_x653c-kernel-source
        path: kernel_source

    # 2. Install dependencies
    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev \
          lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev \
          libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev python3 device-tree-compiler

    # 3. Download and Setup GCC 4.9 Toolchain
    - name: Setup GCC 4.9 (ARM-EABI)
      run: |
        echo "Cloning Toolchain..."
        git clone https://github.com/burstlam/arm-eabi-4.9.git toolchain
        echo "$GITHUB_WORKSPACE/toolchain/bin" >> $GITHUB_PATH

    # 4. Compile the Kernel, DTBs, and DTBO
    - name: Build Kernel and Device Trees
      working-directory: kernel_source
      env:
        ARCH: arm
        CROSS_COMPILE: arm-eabi-
      run: |
        echo "Verifying GCC Version..."
        arm-eabi-gcc --version
        
        echo "Cleaning build tree..."
        make clean && make mrproper
        
        echo "Applying defconfig: ${{ github.event.inputs.defconfig_name }}..."
        make ${{ github.event.inputs.defconfig_name }}
        
        echo "Starting Build..."
        # Build zImage-dtb AND dtbs (Device Tree Blobs)
        # Note: On many MTK kernels, 'dtboimage' is a separate target. 
        # We try to build it; if the target doesn't exist, '|| true' prevents the workflow from failing.
        make -j$(nproc --all) zImage-dtb dtbs
        make -j$(nproc --all) dtboimage || true

    # 5. Gather all important files into one output folder
    - name: Organize Artifacts
      working-directory: kernel_source
      run: |
        mkdir -p build_artifacts
        
        echo "Copying Kernel Images..."
        # Copy zImage-dtb if it exists
        [ -f arch/arm/boot/zImage-dtb ] && cp arch/arm/boot/zImage-dtb build_artifacts/
        # Copy standard zImage
        [ -f arch/arm/boot/zImage ] && cp arch/arm/boot/zImage build_artifacts/
        
        echo "Copying Device Tree Blobs (dtb)..."
        # Copy all compiled .dtb files
        find arch/arm/boot/dts -name "*.dtb" -exec cp {} build_artifacts/ \;
        
        echo "Copying DTBO image..."
        # Find and copy dtbo.img (location varies by kernel version, using find to be safe)
        find . -name "dtbo.img" -exec cp {} build_artifacts/ \;
        
        echo "Copying Debugging Info..."
        # Copy config and System.map for debugging purposes
        cp .config build_artifacts/build_config
        [ -f System.map ] && cp System.map build_artifacts/
        [ -f Module.symvers ] && cp Module.symvers build_artifacts/

        echo "Listing Artifacts:"
        ls -lh build_artifacts/

    # 6. Upload the result
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-output
        path: kernel_source/build_artifacts/*
